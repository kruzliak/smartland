/*! mappi.sk 2016-10-03 */
var dataLayers=[{fullLayerName:"smartland:corine3",shortName:"corine3",worspace:"smartland",displayName:"Corine",description:"",options:{format:"image/png8",version:"1.1.1",transparent:!0},url:"http://smartland.vps.websupport.sk/geoserver/gwc/service/wms?",zIndex:10,load:!0,dataCode:[{title:"Continuous urban fabric",code:111,color:"#e6004d"},{title:"Discontinuous urban fabric",code:112,color:"#ff0000"},{title:"Industrial or commercial units",code:121,color:"#cc4df2"},{title:"Road and rail networks and associated land",code:122,color:"#cc0000"},{title:"Port areas",code:123,color:"#e6cccc"},{title:"Airports",code:124,color:"#e6cce6"},{title:"Mineral extraction sites",code:131,color:"#a600cc"},{title:"Dump sites",code:132,color:"#a64d00"},{title:"Construction sites",code:133,color:"#ff4dff"},{title:"Green urban areas",code:141,color:"#ffa6ff"},{title:"Sport and leisure facilities",code:142,color:"#ffe6ff"},{title:"Non-irrigated arable land",code:211,color:"#ffffa8"},{title:"Permanently irrigated land",code:212,color:"#ffff00"},{title:"Rice fields",code:213,color:"#e6e600"},{title:"Vineyards",code:221,color:"#e68000"},{title:"Fruit trees and berry plantations",code:222,color:"#f2a64d"},{title:"Olive groves",code:223,color:"#e6a600"},{title:"Pastures",code:231,color:"#e6e64d"},{title:"Annual crops associated with permanent crops",code:241,color:"#ffe6a6"},{title:"Complex cultivation patterns",code:242,color:"#ffe64d"},{title:"Land principally occupied by agriculture with significant areas of natural vegetation",code:243,color:"#e6cc4d"},{title:"Agro-forestry areas",code:244,color:"#f2cca6"},{title:"Broad-leaved forest",code:311,color:"#80ff00"},{title:"Coniferous forest",code:312,color:"#00a600"},{title:"Mixed forest",code:313,color:"#4dff00"},{title:"Natural grasslands",code:321,color:"#ccf24d"},{title:"Moors and heathland",code:322,color:"#a6ff80"},{title:"Sclerophyllous vegetation",code:323,color:"#a6e64d"},{title:"Transitional woodland-shrub",code:324,color:"#a6f200"},{title:"Beaches - dunes - sands",code:331,color:"#e6e6e6"},{title:"Bare rocks",code:332,color:"#cccccc"},{title:"Sparsely vegetated areas",code:333,color:"#ccffcc"},{title:"Burnt areas",code:334,color:"#000000"},{title:"Glaciers and perpetual snow",code:335,color:"#a6e6cc"},{title:"Inland marshes",code:411,color:"#a6a6ff"},{title:"Peat bogs",code:412,color:"#4d4dff"},{title:"Salt marshes",code:421,color:"#ccccff"},{title:"Salines",code:422,color:"#e6e6ff"},{title:"Intertidal flats",code:423,color:"#a6a6e6"},{title:"Water courses",code:511,color:"#00ccf2"},{title:"Water bodies",code:512,color:"#80f2e6"},{title:"Coastal lagoons",code:521,color:"#00ffa6"},{title:"Estuaries",code:522,color:"#a6ffe6"},{title:"Sea and ocean",code:523,color:"#e6f2ff"}]},{fullLayerName:"smartland:urban",shortName:"urban",worspace:"smartland",displayName:"Urban Atlas",description:"",options:{format:"image/png8",version:"1.1.1",transparent:!0},url:"http://smartland.vps.websupport.sk/geoserver/gwc/service/wms?",zIndex:11,load:!0,dataCode:{11100:"#a03037",11210:"#ce2430",11220:"#ee2427",11230:"#f6997c",11240:"#fcc9b5",11300:"#cb7e69",12100:"#c66ca5",12210:"#f37924",12220:"#fab586",12230:"#828587",12300:"#e0c1dd",12400:"#e1cbd1",13100:"#9a6c5b",13300:"#cea879",13400:"#ffff00",14100:"#a8bd3d",14200:"#d9e591",20000:"#fff8ba",30000:"#007149",50000:"#0095CF"}}],baseLayer="https://api.mapbox.com/styles/v1/oksid/ciqu276fx000rccmfkt2y7h68/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2tzaWQiLCJhIjoiY2lqYWtwN2s3MDAyeHZva3E0OWlsZTZwNyJ9.wMClMXnln0J9ePTZpRuHvQ",mappi=function(a,b,c){function d(a){var b=a.features[0].id.split(".")[0];return B.filter(function(a){return a.shortName===b})[0]}function e(){E.baseLayer=b.tileLayer(c.baseLayer,{zIndex:100}).addTo(C)}function f(){C.on("zoomend",function(a){c.zoomLevel=C.getZoom()})}function g(){C.on("moveend",function(a){c.center=C.getCenter()})}function h(a){a.forEach(function(a){a.load===!0&&(console.log(a),a.options.layers=a.options.layers||a.fullLayerName,D[a.displayName]=b.tileLayer.wms(a.url,a.options).addTo(C))})}function i(){C.on("click",function(a){r(),j();for(var c in D)if(D.hasOwnProperty(c)){var d=D[c],e=d.wmsParams.layers.split(":")[1];if(d._container){var f=d._map.latLngToContainerPoint(a.latlng,d._map.getZoom()),g=d._map.getSize(),h="",i={request:"GetFeatureInfo",service:"WMS",srs:"EPSG:4326",version:d.wmsParams.version,bbox:d._map.getBounds().toBBoxString(),height:g.y,width:g.x,layers:d.wmsParams.layers,query_layers:d.wmsParams.layers,info_format:"application/json"};i["1.3.0"===i.version?"i":"x"]=f.x,i["1.3.0"===i.version?"j":"y"]=f.y,h=d._url+b.Util.getParamString(i,d._url,!0),k(h,e)}}})}function j(){H={}}function k(b,c){a.ajax({url:b,context:{layerID:c},beforeSend:function(){G.push(c)}}).success(function(a){a.features.length>0&&(H[c]=a)}).fail(function(a){console.log("failed")}).done(function(a){var b=G.indexOf(this.layerID);b>-1&&G.splice(b,1),0===G.length&&l()})}function l(){m(),n()}function m(){console.log("render polygons",H);var a,c,d,e=B.map(function(a){return a.shortName});e.forEach(function(e){a=H[e],a&&(d=s(a.features[0].geometry.coordinates[0]),c=L[e](a),F[e]=b.polygon(d,c).addTo(C))})}function n(){q(),p(),o()}function o(){console.log("_FeaturInfoData",H);for(var b in H)if(H.hasOwnProperty(b)){var c=a("<div>",{class:"mappiInfoBoxItem mappiInfoBoxitem-"+b}).append(a(J[b](H[b])));I.$.append(c),console.log(b+" -> ",H[b])}}function p(){I.$.html("")}function q(){"undefined"==typeof I.$&&(I.$=a("<div>",{class:"mappiInfoBox"}),a(C.getContainer()).append(I.$),I.$.on("click",function(a){return a.stopImmediatePropagation(),!1}))}function r(){var a=B.map(function(a){return a.shortName});a.forEach(function(a){var b=F[a];"undefined"!=typeof b&&C.removeLayer(b)}),console.log(a)}function s(a){var c=0,d=[];if("object"==typeof a[0]){for(c=0;c<a.length;c++)d.push(s(a[c]));return d}var e=new b.Point(a[0],a[1]),f=6378137,g=b.Projection.SphericalMercator.unproject(e.divideBy(f));return g}function t(){C=b.map("map",c.mapOptions).setView(c.center,c.zoomLevel),f(),g(),h(B),e(),i(),b.control.layers({},D).addTo(C),E.baseLayer.setZIndex(100),b.control.scale().addTo(C),b.control.zoom().addTo(C)}function u(){t()}function v(){return C.getCenter()}function w(a){C.panTo(a)}function x(){return C.getZoom()}function y(a){C.setZoom(a)}function z(){return C.getBounds()}function A(){return C.getMinZoom()}var B=c.dataLayers||[],C={},D={},E={},F={},G=[],H={},I={},J={urban:function(a){return"<h2>Urban Atlas</h2><p>"+a.features[0].properties.item+"<p>"},corine3:function(a){var b="<h2>Corine</h2>",c={},d=B.filter(function(a){if("corine3"===a.shortName)return!0}),e=a.features[0].properties.code_12;return d[0].dataCode.filter(function(a){a.code==e&&(b=b+"<p>"+a.title+"</p>",c.description=a.title,c.badgeColor=a.color)}),c.title="Corine",c.name="corine",K(c),b}},K=function(b){return a("<div>",{class:"mappiInfoBoxItem mappiInfoBoxitem-"+b.name,html:a("<h2>",{text:b.title})+a("<p>",{html:a("<span>",{class:"badge",html:"&nbsp;"})+"&nbsp;"+b.description})})},L={urban:function(a){var b={fillOpacity:c.polygon.fillOpacity||.8,weight:3,color:"#000"},e=d(a).dataCode;return console.log("colorCodesMap",e),b.fillColor=e[a.features[0].properties.code],b},corine3:function(a){var b={fillOpacity:c.polygon.fillOpacity||.8,weight:3,color:"#ffffff"},e=d(a),f=e.dataCode.filter(function(b){return b.code==a.features[0].properties.code_12});return b.fillColor=f[0].color,b}};return{loadMap:u,getCenter:v,getZoom:x,setZoom:y,getBounds:z,setCenter:w,getMinZoom:A}}(jQuery,L,{dataLayers:dataLayers,baseLayer:baseLayer,mapOptions:{maxZoom:15,minZoom:5,zoomControl:!1},center:[48.14455610362899,17.114295959472656],zoomLevel:15,polygon:{fillOpacity:.8}});
