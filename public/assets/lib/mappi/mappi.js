/*! mappi.js 2016-10-28 */
var mapiEvents={events:{},on:function(a,b){this.events[a]=this.events[a]||[],this.events[a].push(b)},off:function(a,b){if(this.events[a])for(var c=0;c<this.events[a].length;c++)if(this.events[a][c]===b){this.events[a].splice(c,1);break}},emit:function(a,b){this.events[a]&&this.events[a].forEach(function(a){a(b)})}},dataLayers=[{fullLayerName:"smartland:corine4",shortName:"corine4",worspace:"smartland",displayName:"Corine",description:"",options:{format:"image/png8",version:"1.1.1",transparent:!0},url:"http://smartland.vps.websupport.sk/geoserver/gwc/service/wms?",zIndex:10,load:!0,dataCode:[{title:"Continuous urban fabric",code:111,color:"#e6004d"},{title:"Discontinuous urban fabric",code:112,color:"#ff0000"},{title:"Industrial or commercial units",code:121,color:"#cc4df2"},{title:"Road and rail networks and associated land",code:122,color:"#cc0000"},{title:"Port areas",code:123,color:"#e6cccc"},{title:"Airports",code:124,color:"#e6cce6"},{title:"Mineral extraction sites",code:131,color:"#a600cc"},{title:"Dump sites",code:132,color:"#a64d00"},{title:"Construction sites",code:133,color:"#ff4dff"},{title:"Green urban areas",code:141,color:"#ffa6ff"},{title:"Sport and leisure facilities",code:142,color:"#ffe6ff"},{title:"Non-irrigated arable land",code:211,color:"#ffffa8"},{title:"Permanently irrigated land",code:212,color:"#ffff00"},{title:"Rice fields",code:213,color:"#e6e600"},{title:"Vineyards",code:221,color:"#e68000"},{title:"Fruit trees and berry plantations",code:222,color:"#f2a64d"},{title:"Olive groves",code:223,color:"#e6a600"},{title:"Pastures",code:231,color:"#e6e64d"},{title:"Annual crops associated with permanent crops",code:241,color:"#ffe6a6"},{title:"Complex cultivation patterns",code:242,color:"#ffe64d"},{title:"Land principally occupied by agriculture with significant areas of natural vegetation",code:243,color:"#e6cc4d"},{title:"Agro-forestry areas",code:244,color:"#f2cca6"},{title:"Broad-leaved forest",code:311,color:"#80ff00"},{title:"Coniferous forest",code:312,color:"#00a600"},{title:"Mixed forest",code:313,color:"#4dff00"},{title:"Natural grasslands",code:321,color:"#ccf24d"},{title:"Moors and heathland",code:322,color:"#a6ff80"},{title:"Sclerophyllous vegetation",code:323,color:"#a6e64d"},{title:"Transitional woodland-shrub",code:324,color:"#a6f200"},{title:"Beaches - dunes - sands",code:331,color:"#e6e6e6"},{title:"Bare rocks",code:332,color:"#cccccc"},{title:"Sparsely vegetated areas",code:333,color:"#ccffcc"},{title:"Burnt areas",code:334,color:"#000000"},{title:"Glaciers and perpetual snow",code:335,color:"#a6e6cc"},{title:"Inland marshes",code:411,color:"#a6a6ff"},{title:"Peat bogs",code:412,color:"#4d4dff"},{title:"Salt marshes",code:421,color:"#ccccff"},{title:"Salines",code:422,color:"#e6e6ff"},{title:"Intertidal flats",code:423,color:"#a6a6e6"},{title:"Water courses",code:511,color:"#00ccf2"},{title:"Water bodies",code:512,color:"#80f2e6"},{title:"Coastal lagoons",code:521,color:"#00ffa6"},{title:"Estuaries",code:522,color:"#a6ffe6"},{title:"Sea and ocean",code:523,color:"#e6f2ff"}]},{fullLayerName:"smartland:urban",shortName:"urban",worspace:"smartland",displayName:"Urban Atlas",description:"",options:{format:"image/png8",version:"1.1.1",transparent:!0},url:"http://smartland.vps.websupport.sk/geoserver/gwc/service/wms?",zIndex:11,load:!0,dataCode:[{title:"Continuous Urban Fabric (S.L. > 80%)",code:11100,color:"#a03037"},{title:"Discontinuous Dense Urban Fabric (S.L. : 50% -  80%)",code:11210,color:"#ce2430"},{title:"Discontinuous Medium Density Urban Fabric (S.L. : 30% - 50%)",code:11220,color:"#ee2427"},{title:"Discontinuous Low Density Urban Fabric (S.L. : 10% - 30%)",code:11230,color:"#f6997c"},{title:"Discontinuous Very Low Density Urban Fabric (S.L. less 10%)",code:11240,color:"#fcc9b5"},{title:"Isolated Structures ",code:11300,color:"#cb7e69"},{title:"Industrial, commercial, public, military and private units",code:12100,color:"#c66ca5"},{title:"Fast transit roads and associated land",code:12210,color:"#f37924"},{title:"Other roads and associated land",code:12220,color:"#fab586"},{title:"Railways and associated land",code:12230,color:"#828587"},{title:"Port areas",code:12300,color:"#e0c1dd"},{title:"Airports",code:12400,color:"#e1cbd1"},{title:"Mineral extraction and dump sites",code:13100,color:"#9a6c5b"},{title:"Construction sites",code:13300,color:"#cea879"},{title:"Land without current use",code:13400,color:"#ffff00"},{title:"Green urban areas",code:14100,color:"#a8bd3d"},{title:"Sports and leisure facilities",code:14200,color:"#d9e591"},{title:"Agricultural + Semi-natural areas + Wetlands",code:2e4,color:"#fff8ba"},{title:"Forests",code:3e4,color:"#007149"},{title:"Water bodies",code:5e4,color:"#0095cf"}]}],baseLayer="https://api.mapbox.com/styles/v1/oksid/ciqu276fx000rccmfkt2y7h68/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2tzaWQiLCJhIjoiY2lqYWtwN2s3MDAyeHZva3E0OWlsZTZwNyJ9.wMClMXnln0J9ePTZpRuHvQ",mappi=function(a,b,c){function d(a){var b=a.features[0].id.split(".")[0];return D.filter(function(a){return a.shortName===b})[0]}function e(){G.baseLayer=b.tileLayer(c.baseLayer,{zIndex:100}).addTo(E)}function f(){E.on("zoomend",function(a){c.zoomLevel=E.getZoom()})}function g(){E.on("moveend",function(a){c.center=E.getCenter()})}function h(a){a.forEach(function(a){a.load===!0&&(console.log(a),a.options.layers=a.options.layers||a.fullLayerName,F[a.displayName]=b.tileLayer.wms(a.url,a.options).addTo(E))})}function i(){E.on("click",function(a){s(),k();for(var c in F)if(F.hasOwnProperty(c)){var d=F[c],e=d.wmsParams.layers.split(":")[1];if(d._container){j("start");var f=d._map.latLngToContainerPoint(a.latlng,d._map.getZoom()),g=d._map.getSize(),h="",i={request:"GetFeatureInfo",service:"WMS",srs:"EPSG:4326",version:d.wmsParams.version,bbox:d._map.getBounds().toBBoxString(),height:g.y,width:g.x,layers:d.wmsParams.layers,query_layers:d.wmsParams.layers,info_format:"application/json"};i["1.3.0"===i.version?"i":"x"]=f.x,i["1.3.0"===i.version?"j":"y"]=f.y,h=d._url+b.Util.getParamString(i,d._url,!0),l(h,e)}}})}function j(b){"start"===b&&a("#loadIndicator").addClass("loading"),"end"!==b&&b||a("#loadIndicator").removeClass("loading")}function k(){J={}}function l(b,c){a.ajax({url:b,context:{layerID:c},beforeSend:function(){I.push(c)}}).success(function(a){a.features.length>0&&(J[c]=a)}).fail(function(a){console.log("failed")}).done(function(a){var b=I.indexOf(this.layerID);b>-1&&I.splice(b,1),0===I.length&&(m(),j("end"))})}function m(){n(),o()}function n(){console.log("render polygons",J);var a,c,d,e=D.map(function(a){return a.shortName});e.forEach(function(e){a=J[e],a&&(d=t(a.features[0].geometry.coordinates[0]),c=N[e](a),H[e]=b.polygon(d,c).addTo(E))})}function o(){r(),q(),p()}function p(){console.log("_FeaturInfoData",J);for(var b in J)if(J.hasOwnProperty(b)){var c=a("<div>",{class:"mappiInfoBoxItem mappiInfoBoxitem-"+b}).append(a(L[b](J[b])));K.$.append(c),console.log(b+" -> ",J[b])}}function q(){K.$.html("")}function r(){"undefined"==typeof K.$&&(K.$=a("<div>",{class:"mappiInfoBox"}).on("click",function(a){return a.stopImmediatePropagation(),!1})),0===a(E.getContainer()).find(".mappiInfoBox").length&&a(E.getContainer()).append(K.$)}function s(){var a=D.map(function(a){return a.shortName});a.forEach(function(a){var b=H[a];"undefined"!=typeof b&&E.removeLayer(b)}),console.log(a)}function t(a){var c=0,d=[];if("object"==typeof a[0]){for(c=0;c<a.length;c++)d.push(t(a[c]));return d}var e=new b.Point(a[0],a[1]),f=6378137,g=b.Projection.SphericalMercator.unproject(e.divideBy(f));return g}function u(){E=b.map("map",c.mapOptions).setView(c.center,c.zoomLevel),f(),g(),h(D),e(),i(),b.control.layers({},F).addTo(E),G.baseLayer.setZIndex(100),b.control.scale({imperial:!1}).addTo(E),b.control.zoom().addTo(E)}function v(){u()}function w(a){return D.push(a),u(),D}function x(){return E.getCenter()}function y(a){E.panTo(a)}function z(){return E.getZoom()}function A(a){E.setZoom(a)}function B(){return E.getBounds()}function C(){return E.getMinZoom()}var D=c.dataLayers||[],E={},F={},G={},H={},I=[],J={},K={},L={urban:function(a){return"<h2>Urban Atlas</h2><p>"+a.features[0].properties.item+"<p>"},corine4:function(a){var b="<h2>Corine</h2>",c={},d=D.filter(function(a){if("corine4"===a.shortName)return!0}),e=a.features[0].properties.code_12;return d[0].dataCode.filter(function(a){a.code==e&&(b=b+"<p>"+a.title+"</p>",c.description=a.title,c.badgeColor=a.color)}),c.title="Corine",c.name="corine",M(c),b}},M=function(b){return a("<div>",{class:"mappiInfoBoxItem mappiInfoBoxitem-"+b.name,html:a("<h2>",{text:b.title})+a("<p>",{html:a("<span>",{class:"badge",html:"&nbsp;"})+"&nbsp;"+b.description})})},N={urban:function(a){var b={fillOpacity:c.polygon.fillOpacity||.8,weight:3,color:"#000"},e=d(a).dataCode,f=d(a);return console.log("colorCodesMap",e),b.fillColor=e[a.features[0].properties.code],b.fillColor=f.dataCode.filter(function(b){return b.code==a.features[0].properties.code})[0].color,b},corine4:function(a){var b={fillOpacity:c.polygon.fillOpacity||.8,weight:3,color:"#000"},e=d(a);return b.fillColor=e.dataCode.filter(function(b){return b.code==a.features[0].properties.code_12})[0].color,b}};return{loadMap:v,getCenter:x,getZoom:z,setZoom:A,getBounds:B,setCenter:y,getMinZoom:C,addDataLayer:w}}(jQuery,L,{dataLayers:dataLayers,baseLayer:baseLayer,mapOptions:{maxZoom:15,minZoom:5,zoomControl:!1},center:[48.14455610362899,17.114295959472656],zoomLevel:5,polygon:{fillOpacity:.8}});
